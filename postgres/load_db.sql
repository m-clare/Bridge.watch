DROP TABLE nbi_raw;
CREATE TABLE nbi_raw (
state TEXT,
structure_number TEXT,
inventory_route_record_type TEXT,
inventory_route_route_signing_prefix TEXT,
inventory_route_designated_level_of_service TEXT,
inventory_route_number TEXT,
inventory_route_direction TEXT,
highway_agency_district TEXT,
county_code TEXT,
place_code TEXT,
features_intersected TEXT,
critical_facility TEXT,
facility_carried TEXT,
location TEXT,
inventory_route_minimum_vertical_clearance TEXT,
kilometerpoint TEXT,
base_highway_network TEXT,
lrs_inventory_route TEXT,
subroute_number TEXT,
latitude TEXT,
longitude TEXT,
bypass_detour_length TEXT,
toll TEXT,
maintenance_responsibility TEXT,
owner TEXT,
functional_classification_of_inventory_route TEXT,
year_bult TEXT,
traffic_lanes_on_structure TEXT,
traffic_lanes_under_structure TEXT,
average_daily_traffic TEXT,
year_of_average_daily_traffic TEXT,
design_load TEXT,
approach_roadway_width TEXT,
bridge_median TEXT,
skew_angle TEXT,
structure_flared TEXT,
traffic_safety_features_bridge_railings TEXT,
traffic_safety_features_transitions TEXT,
traffic_safety_features_approach_guardrail TEXT,
traffic_safety_features_approach_guardrail_ends TEXT,
historical_significance TEXT,
navigation_control TEXT,
navigation_vertical_clearance TEXT,
navigation_horizontal_clearance TEXT,
structure_open_posted_closed_to_traffic TEXT,
type_of_service_on_bridge TEXT,
type_of_service_under_bridge TEXT,
structure_kind TEXT,
structure_type TEXT,
structure_type_approach_spans_material TEXT,
structure_type_approach_design TEXT,
main_unit_span_number TEXT,
number_of_approach_spans TEXT,
inventory_route_total_horizontal_clearance TEXT,
maximum_span_length TEXT,
structure_length TEXT,
left_curb_width TEXT,
right_curb_width TEXT,
bridge_roadway_width TEXT,
deck_width TEXT,
minimum_vertical_clearance_over_bridge_roadway TEXT,
minimum_vertical_underclearance_reference_feature TEXT,
minimum_vertical_underclearance TEXT,
minimum_lateral_underclearance_on_right TEXT,
minimum_lateral_underclearance_reference_feature TEXT,
minimum_lateral_underclearance_on_left TEXT,
deck_condition TEXT,
superstructure_condition TEXT,
substructure_condition TEXT,
channel_condition TEXT,
culvert_condition TEXT,
operating_rating_method TEXT,
operating_rating TEXT,
inventory_rating_method TEXT,
inventory_rating TEXT,
structural_evaluation TEXT,
deck_geometry_evaluation TEXT,
underclearance_evaluation TEXT,
posting_evaluation TEXT,
waterway_evaluation TEXT,
approach_roadway_alignment TEXT,
type_of_work_proposed TEXT,
type_of_work_done_by TEXT,
length_of_structure_improvement TEXT,
date_of_inspection TEXT,
designated_inspection_frequency TEXT,
critical_feature_inspection_fracture TEXT,
critical_feature_inspection_underwater TEXT,
critical_feature_inspection_other_special TEXT,
critical_feature_inspection_fracture_date TEXT,
critical_feature_inspection_underwater_date TEXT,
critical_feature_inspection_other_special_date TEXT,
bridge_improvement_cost TEXT,
roadway_improvement_cost TEXT,
total_project_improvement_cost TEXT,
year_of_improvement_cost_estimate TEXT,
border_bridge_neighboring_state_code TEXT,
border_bridge_percent_responsibility TEXT,
border_bridge_structure_number TEXT,
STRAHNET_highway_designation TEXT,
parallel_structure_designation TEXT,
traffic_direction TEXT,
temporary_structure_designation TEXT,
highway_system TEXT,
federal_lands_highway TEXT,
year_reconstructed TEXT,
deck_structure_type TEXT,
deck_wearing_surface_type TEXT,
deck_wearing_surface_membrane_type TEXT,
wearing_surface_deck_protection TEXT,
average_daily_truck_traffic TEXT,
national_network TEXT,
pier_or_abutment_protection TEXT,
NBIS_bridge_length TEXT,
scour_critical TEXT,
future_average_daily_traffic TEXT,
year_of_future_average_daily_traffic TEXT,
minimum_navigation_vertical_clearance_vertical_lift_bridge TEXT,
federal_agency TEXT,
submitted_by TEXT,
bridge_condition TEXT,
lowest_rating TEXT,
deck_area TEXT
 );

\copy nbi_raw(state,structure_number,inventory_route_record_type,inventory_route_route_signing_prefix,inventory_route_designated_level_of_service,inventory_route_number,inventory_route_direction,highway_agency_district,county_code,place_code,features_intersected,critical_facility,facility_carried,location,inventory_route_minimum_vertical_clearance,kilometerpoint,base_highway_network,lrs_inventory_route,subroute_number,latitude,longitude,bypass_detour_length,toll,maintenance_responsibility,owner,functional_classification_of_inventory_route,year_bult,traffic_lanes_on_structure,traffic_lanes_under_structure,average_daily_traffic,year_of_average_daily_traffic,design_load,approach_roadway_width,bridge_median,skew_angle,structure_flared,traffic_safety_features_bridge_railings,traffic_safety_features_transitions,traffic_safety_features_approach_guardrail,traffic_safety_features_approach_guardrail_ends,historical_significance,navigation_control,navigation_vertical_clearance,navigation_horizontal_clearance,structure_open_posted_closed_to_traffic,type_of_service_on_bridge,type_of_service_under_bridge,structure_kind,structure_type,structure_type_approach_spans_material,structure_type_approach_design,main_unit_span_number,number_of_approach_spans,inventory_route_total_horizontal_clearance,maximum_span_length,structure_length,left_curb_width,right_curb_width,bridge_roadway_width,deck_width,minimum_vertical_clearance_over_bridge_roadway,minimum_vertical_underclearance_reference_feature,minimum_vertical_underclearance,minimum_lateral_underclearance_on_right,minimum_lateral_underclearance_reference_feature,minimum_lateral_underclearance_on_left,deck_condition,superstructure_condition,substructure_condition,channel_condition,culvert_condition,operating_rating_method,operating_rating,inventory_rating_method,inventory_rating,structural_evaluation,deck_geometry_evaluation,underclearance_evaluation,posting_evaluation,waterway_evaluation,approach_roadway_alignment,type_of_work_proposed,type_of_work_done_by,length_of_structure_improvement,date_of_inspection,designated_inspection_frequency,critical_feature_inspection_fracture,critical_feature_inspection_underwater,critical_feature_inspection_other_special,critical_feature_inspection_fracture_date,critical_feature_inspection_underwater_date,critical_feature_inspection_other_special_date,bridge_improvement_cost,roadway_improvement_cost,total_project_improvement_cost,year_of_improvement_cost_estimate,border_bridge_neighboring_state_code,border_bridge_percent_responsibility,border_bridge_structure_number,STRAHNET_highway_designation,parallel_structure_designation,traffic_direction,temporary_structure_designation,highway_system,federal_lands_highway,year_reconstructed,deck_structure_type,deck_wearing_surface_type,deck_wearing_surface_membrane_type,wearing_surface_deck_protection,average_daily_truck_traffic,national_network,pier_or_abutment_protection,NBIS_bridge_length,scour_critical,future_average_daily_traffic,year_of_future_average_daily_traffic,minimum_navigation_vertical_clearance_vertical_lift_bridge,federal_agency,submitted_by,bridge_condition,lowest_rating,deck_area) FROM 'BadCleaned.csv' WITH DELIMITER ',' CSV HEADER ;

DROP TABLE state;
CREATE TABLE state (
  id SERIAL,
  name VARCHAR(24) UNIQUE,
  fips_code CHAR(2) UNIQUE,
  PRIMARY KEY(id)
  );

\copy state(name, fips_code) FROM 'state.csv' WITH DELIMITER ',' CSV HEADER ;

ALTER TABLE nbi_raw ADD COLUMN state_id INTEGER REFERENCES state(id) ON DELETE CASCADE;
UPDATE nbi_raw SET state_id = (SELECT state.id FROM state WHERE state.fips_code = nbi_raw.state);

DROP TABLE toll;
CREATE TABLE toll (
  id SERIAL,
  code VARCHAR(1) UNIQUE,
  description TEXT UNIQUE,
  PRIMARY KEY(id)
  );

\copy toll(code,description) from 'toll.csv' WITH DELIMITER ',' CSV HEADER;

ALTER TABLE nbi_raw ADD COLUMN toll_id INTEGER REFERENCES toll(id) ON DELETE CASCADE;
UPDATE nbi_raw SET toll_id = (SELECT toll.id FROM toll WHERE toll.code = nbi_raw.toll);
